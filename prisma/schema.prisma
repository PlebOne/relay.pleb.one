// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management for relay access
model User {
  id          String   @id @default(cuid())
  npub        String   @unique
  pubkey      String   @unique
  email       String?
  passwordHash String?
  displayName String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isAdmin     Boolean  @default(false)
  whitelistStatus WhitelistStatus @default(PENDING)
  whitelistNotes  String?
  inviteQuota     Int      @default(5)
  invitesUsed     Int      @default(0)
  invitePrivilegesSuspended Boolean @default(false)
  inviteSuspensionReason String?
  blacklistViolations Int @default(0)
  lastBlacklistViolation DateTime?
  permanentlyBanned Boolean @default(false)
  accountAgeMonths Int @default(0)
  lastQuotaIncrease DateTime?
  requiresAdminApproval Boolean @default(false)
  lastInviteRefresh DateTime @default(now())
  invitedById     String?
  nip05Name       String? @unique
  nip05Enabled    Boolean @default(false)
  
  // Relations
  events        Event[]
  invitesMade   WhitelistInvite[] @relation("InvitesMade")
  invitesReceived WhitelistInvite[] @relation("InviteReceived")
  invitesApproved WhitelistInvite[] @relation("InvitesApproved")
  invitedBy     User? @relation("InvitedByRelation", fields: [invitedById], references: [id])
  usersInvited  User[] @relation("InvitedByRelation")
  resolvedMessages AdminMessage[]
  
  @@map("users")
  @@index([nip05Name])
}

// Nostr events storage
model Event {
  id          String   @id @default(cuid())
  eventId     String   @unique // Nostr event ID
  pubkey      String   // Author's public key
  kind        Int      // Event kind
  content     String   // Event content
  tags        Json     // Event tags as JSON
  sig         String   // Event signature
  createdAt   DateTime @default(now())
  receivedAt  DateTime @default(now())
  expiresAt   DateTime? // NIP-40 Expiration
  
  // Relations
  author User? @relation(fields: [pubkey], references: [pubkey])
  
  // Indexes for performance
  @@index([kind])
  @@index([pubkey])
  @@index([createdAt])
  @@index([eventId])
  
  @@map("events")
}


model WhitelistInvite {
  id            String                @id @default(cuid())
  inviterId     String
  inviteeId     String?
  inviteeNpub   String
  inviteePubkey String
  inviteeName   String?
  notes         String?
  status        WhitelistInviteStatus @default(APPROVED)
  approvedById  String?
  createdAt     DateTime              @default(now())
  approvedAt    DateTime?

  inviter    User @relation("InvitesMade", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee    User? @relation("InviteReceived", fields: [inviteeId], references: [id])
  approvedBy User? @relation("InvitesApproved", fields: [approvedById], references: [id])

  @@map("whitelist_invites")
  @@index([inviteePubkey])
  @@index([inviteeId])
}

// Relay statistics and metrics
model RelayStats {
  id          String   @id @default(cuid())
  date        DateTime @unique @default(now())
  totalEvents Int      @default(0)
  totalUsers  Int      @default(0)
  activeUsers Int      @default(0)
  revenue     Int      @default(0) // in sats

  @@map("relay_stats")
}

// Rate limiting tracking
model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique // IP or pubkey
  count     Int      @default(1)
  resetAt   DateTime
  createdAt DateTime @default(now())
  
  @@map("rate_limits")
}

// Admin message board for support requests, blacklist reports, etc.
model AdminMessage {
  id              String              @id @default(cuid())
  type            AdminMessageType
  status          AdminMessageStatus  @default(PENDING)
  subject         String
  content         String
  submitterNpub   String?
  submitterPubkey String?
  targetNpub      String?             // For blacklist requests or whitelist requests
  targetPubkey    String?
  metadata        Json?               // Additional context (IP, user agent, etc.)
  resolvedById    String?
  resolvedAt      DateTime?
  resolution      String?             // Admin notes on how it was resolved
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  resolvedBy      User?               @relation(fields: [resolvedById], references: [id])
  
  @@map("admin_messages")
  @@index([type])
  @@index([status])
  @@index([targetPubkey])
}

enum AdminMessageType {
  BLACKLIST_REQUEST
  WHITELIST_REQUEST
  SUPPORT_REQUEST
  APPEAL
  REPORT
}

enum AdminMessageStatus {
  PENDING
  IN_REVIEW
  APPROVED
  DENIED
  RESOLVED
}


enum WhitelistStatus {
  PENDING
  ACTIVE
  PAUSED
  REVOKED
  VANISHED
}

enum WhitelistInviteStatus {
  PENDING
  APPROVED
  REJECTED
}